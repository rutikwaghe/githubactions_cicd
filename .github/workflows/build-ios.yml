name: Build iOS App

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: macos-latest

    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install JS dependencies
        run: yarn install

      - name: Install CocoaPods
        run: |
          cd ios
          pod install

      - name: Setup code signing (cert + profile)
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles

          echo "${{ secrets.IOS_CERT_BASE64 }}" | base64 --decode > dist.p12
          echo "${{ secrets.IOS_PROVISION_BASE64 }}" | base64 --decode > profile.mobileprovision

          UUID=$(grep -aA1 UUID profile.mobileprovision | grep -io "[-A-F0-9]\{36\}" | head -1)
          mv profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision

          security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" ios-build.keychain
          security default-keychain -s ios-build.keychain
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" ios-build.keychain
          security import dist.p12 -k ios-build.keychain -P "${{ secrets.IOS_CERT_PASSWORD }}" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "${{ secrets.KEYCHAIN_PASSWORD }}" ios-build.keychain

      - name: Debug Code Signing Identities
        run: |
          security find-identity -v -p codesigning

      - name: Build and Export .ipa
        run: |
          set -x
          cd ios

          xcodebuild \
            -workspace otagithubactions.xcworkspace \
            -scheme otagithubactions \
            -configuration Release \
            -sdk iphoneos \
            -archivePath $PWD/build/App.xcarchive \
            DEVELOPMENT_TEAM=${{ secrets.DEVELOPMENT_TEAM }} \
            CODE_SIGN_IDENTITY="${{ secrets.CODE_SIGN_IDENTITY }}" \
            PRODUCT_BUNDLE_IDENTIFIER=${{ secrets.BUNDLE_ID }} \
            archive

          xcodebuild \
            -exportArchive \
            -archivePath $PWD/build/App.xcarchive \
            -exportPath $PWD/build/export \
            -exportOptionsPlist ExportOptions.plist

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-enterprise-ipa
          path: ios/build/export/*.ipa




# name: Build iOS App

# on:
#   push:
#     branches:
#       - main

# jobs:
#   build:
#     runs-on: macos-latest

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       - name: Set up Node
#         uses: actions/setup-node@v4
#         with:
#           node-version: 18

#       - name: Install dependencies
#         run: yarn install

#       - name: Install CocoaPods dependencies
#         run: |
#           cd ios
#           pod install

#       - name: Decode and install provisioning profile & certificate
#         run: |
#           # Create directories
#           mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles

#           # Decode .p12 and provisioning profile
#           echo "${{ secrets.IOS_CERT_BASE64 }}" | base64 --decode > cert.p12
#           echo "${{ secrets.IOS_PROVISION_BASE64 }}" | base64 --decode > profile.mobileprovision

#           # Move provisioning profile
#           UUID=$(grep -aA1 UUID profile.mobileprovision | grep -io "[-A-F0-9]\{36\}" | head -1)
#           mv profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision

#           # Create and unlock keychain
#           security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" ios-build.keychain
#           security default-keychain -s ios-build.keychain
#           security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" ios-build.keychain
#           security import cert.p12 -k ios-build.keychain -P "${{ secrets.IOS_CERT_PASSWORD }}" -T /usr/bin/codesign
#           security set-key-partition-list -S apple-tool:,apple: -s -k "${{ secrets.KEYCHAIN_PASSWORD }}" ios-build.keychain

#       - name: Build iOS .ipa
#         run: |
#           cd ios
#           xcodebuild \
#             -workspace otagithubactions.xcworkspace \
#             -scheme otagithubactions \
#             -configuration Release \
#             -sdk iphoneos \
#             -archivePath $PWD/build/otagithubactions.xcarchive \
#             DEVELOPMENT_TEAM=${{ secrets.DEVELOPMENT_TEAM }} \
#             CODE_SIGN_IDENTITY="${{ secrets.CODE_SIGN_IDENTITY }}" \
#             PRODUCT_BUNDLE_IDENTIFIER=${{ secrets.BUNDLE_ID }} \
#             archive

#           xcodebuild \
#             -exportArchive \
#             -archivePath $PWD/build/otagithubactions.xcarchive \
#             -exportPath $PWD/build/export \
#             -exportOptionsPlist ExportOptions.plist

#       - name: Upload IPA
#         uses: actions/upload-artifact@v4
#         with:
#           name: ios-ipa
#           path: ios/build/export/*.ipa